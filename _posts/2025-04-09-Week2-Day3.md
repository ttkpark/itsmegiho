---
layout: post
title: "Week 2 Day 3 â€“ Janusì™€ 1:1 ì˜¤ë””ì˜¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ë° ì—°ê²° ìƒíƒœ ë¡œê·¸ í™•ì¸"
date : 2025-04-09
categories: [SFU_project]
---
# Week 2 Day 3 â€“ Janusì™€ 1:1 ì˜¤ë””ì˜¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ë° ì—°ê²° ìƒíƒœ ë¡œê·¸ í™•ì¸

ì•ˆë…•í•˜ì„¸ìš”! **Week 2 Day 3** ìˆ˜ì—… ìë£Œì…ë‹ˆë‹¤.  
ì˜¤ëŠ˜ì€ ì•ˆë“œë¡œì´ë“œ ì•±ì—ì„œ Janus SFUì— ì—°ê²°í•´ **EchoTest ë˜ëŠ” AudioBridge plugin**ì„ í†µí•´  
**1:1 ì˜¤ë””ì˜¤ ì—°ê²°ì„ ì‹¤ì œë¡œ í…ŒìŠ¤íŠ¸**í•©ë‹ˆë‹¤.

ë˜í•œ ì—°ê²° ë„ì¤‘ ë°œìƒí•˜ëŠ” **ICE ì—°ê²° ìƒíƒœ**, **DTLS Handshake**, **SRTP í™œì„±í™”** ë“±ì˜ ê³¼ì •ì„ ë¡œê·¸ë¡œ í™•ì¸í•˜ë©°,  
**ì˜¤ë””ì˜¤ ê¶Œí•œ**ê³¼ **ë§ˆì´í¬ ë™ì‘** ê´€ë ¨ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ì‹¤ìŠµë„ í•¨ê»˜ ì§„í–‰í•©ë‹ˆë‹¤.

---

## 1. ëª©í‘œ

1. Janus EchoTest ë˜ëŠ” AudioBridge Pluginê³¼ ì‹¤ì œ ì˜¤ë””ì˜¤ ì—°ê²°
2. `createOffer()` â†’ `setLocalDescription()` â†’ `Janusë¡œ ì „ì†¡` â†’ `Answer ìˆ˜ì‹  ë° setRemoteDescription()` êµ¬í˜„
3. ICE / DTLS ìƒíƒœ ë¡œê·¸ í™•ì¸
4. ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ì²˜ë¦¬ ë° ì˜¤ë””ì˜¤ ì¶œë ¥ í™•ì¸
5. Gitìœ¼ë¡œ ì‘ì—… ì»¤ë°‹ ì •ë¦¬

---

## 2. ì „ì œ ì¡°ê±´ ì²´í¬

| í•­ëª© | ì²´í¬ |
|------|------|
| âœ… Janus SFU ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ (EchoTest ë˜ëŠ” AudioBridge plugin í™œì„±í™”) |  
| âœ… Android ì•±ì—ì„œ `createOffer()`ì™€ WebSocket ì—°ê²°ê¹Œì§€ êµ¬í˜„ ì™„ë£Œ (Day 2 ì™„ë£Œ ë‚´ìš©) |  
| âœ… ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­(Compose + Accompanist ì ìš©) êµ¬í˜„ë˜ì–´ ìˆìŒ |  
| âœ… Git ë¸Œëœì¹˜ ì „ëµ ì ìš© ì¤‘ (`feature/webrtc-offer-signal`) |

---

## 3. ì‹¤ìŠµ ë‹¨ê³„

---

### âœ… Step 1. Git ë¸Œëœì¹˜ ìƒì„±

```bash
git checkout develop
git pull
git checkout -b feature/webrtc-audio-test
```

---

### âœ… Step 2. ì˜¤ë””ì˜¤ ê¶Œí•œ ì²´í¬ (Compose + Accompanist)

**íŒŒì¼**: `MainScreen.kt`

```kotlin
@OptIn(ExperimentalPermissionsApi::class)
@Composable
fun MainScreen() {
    val audioPermissionState = rememberPermissionState(Manifest.permission.RECORD_AUDIO)
    val context = LocalContext.current

    var log by remember { mutableStateOf("ğŸ§ Ready...\n") }
    var isConnected by remember { mutableStateOf(false) }

    LaunchedEffect(Unit) {
        if (!audioPermissionState.status.isGranted) {
            audioPermissionState.launchPermissionRequest()
        }
    }

    // UI
    Column(modifier = Modifier.padding(16.dp)) {
        if (!audioPermissionState.status.isGranted) {
            Text("âš ï¸ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
        }

        Button(onClick = {
            if (audioPermissionState.status.isGranted) {
                log += "ğŸ¤ ê¶Œí•œ í™•ì¸ë¨, ì—°ê²° ì‹œë„ ì¤‘...\n"
                // WebRTC ì—°ê²° ì‹œë„
                connectToJanusEchoTest { log += it }
            } else {
                log += "ğŸš« ê¶Œí•œ ì—†ìŒ. ìš”ì²­ ì¤‘...\n"
                audioPermissionState.launchPermissionRequest()
            }
        }) {
            Text("1:1 ì˜¤ë””ì˜¤ ì—°ê²°")
        }

        Text(text = log)
    }
}
```

---

### âœ… Step 3. Janus EchoTest Pluginê³¼ ì—°ê²° êµ¬í˜„

**í•µì‹¬ íë¦„ ìš”ì•½**:

1. WebSocket ì—°ê²° â†’ `create`  
2. `attach` (plugin: echotest or audiobridge)  
3. `createOffer()`  
4. `send message + jsep` â†’ Janusì—ê²Œ SDP Offer ì „ë‹¬  
5. ì‘ë‹µìœ¼ë¡œ Answer ë°›ìœ¼ë©´ `setRemoteDescription()`  
6. ICE candidateëŠ” trickleë¡œ ì „ë‹¬  
7. ì˜¤ë””ì˜¤ ì†¡ìˆ˜ì‹  í™•ì¸

---

### âœ… Step 4. SignalingClient í™•ì¥

**íŒŒì¼**: `SignalingClient.kt`

```kotlin
fun sendCreateSession() {
    val obj = JSONObject().apply {
        put("janus", "create")
        put("transaction", generateTransactionId())
    }
    send(obj)
}

fun sendAttachPlugin(sessionId: Long, plugin: String = "janus.plugin.echotest") {
    val obj = JSONObject().apply {
        put("janus", "attach")
        put("session_id", sessionId)
        put("plugin", plugin)
        put("transaction", generateTransactionId())
    }
    send(obj)
}
```

---

### âœ… Step 5. ì—°ê²° ì½”ë“œ êµ¬ì„±

**íŒŒì¼**: `WebRTCConnector.kt`

```kotlin
fun connectToJanusEchoTest(logCallback: (String) -> Unit) {
    val signaling = SignalingClient("ws://<YOUR_JANUS_IP>:8188") { message ->
        // ì‘ë‹µ ë¶„ì„
        logCallback("ğŸ“¥ ì‘ë‹µ: ${message.optString("janus")}")

        when (message.optString("janus")) {
            "success" -> {
                val sessionId = message.getJSONObject("data").optLong("id")
                logCallback("âœ… ì„¸ì…˜ ìƒì„± ì™„ë£Œ: $sessionId")
                signaling.sendAttachPlugin(sessionId)
            }
            "attached" -> {
                logCallback("ğŸ”— í”ŒëŸ¬ê·¸ì¸ ì—°ê²°ë¨")
                startWebRTCConnection(signaling, logCallback) // Offer ìƒì„± í›„ ì „ì†¡
            }
            "event" -> {
                val jsep = message.optJSONObject("jsep")
                if (jsep != null && jsep.getString("type") == "answer") {
                    logCallback("âœ… Answer ìˆ˜ì‹  ì™„ë£Œ")
                    val answer = SessionDescription(SessionDescription.Type.ANSWER, jsep.getString("sdp"))
                    peerConnection?.setRemoteDescription(object : SdpObserverAdapter() {
                        override fun onSetSuccess() {
                            logCallback("ğŸ‰ RemoteDescription ì„¤ì • ì™„ë£Œ")
                        }
                    }, answer)
                }
            }
        }
    }

    signaling.connect()
    signaling.sendCreateSession()
}
```

---

### âœ… Step 6. PeerConnection ì—°ê²° êµ¬í˜„

```kotlin
var peerConnection: PeerConnection? = null

fun startWebRTCConnection(signaling: SignalingClient, logCallback: (String) -> Unit) {
    val factory = WebRTCFactoryManager.factory

    val rtcConfig = PeerConnection.RTCConfiguration(emptyList())
    peerConnection = factory.createPeerConnection(rtcConfig, object : PeerConnection.Observer {
        override fun onIceCandidate(candidate: IceCandidate?) {
            candidate?.let {
                val json = JSONObject().apply {
                    put("janus", "trickle")
                    put("candidate", JSONObject().apply {
                        put("candidate", it.sdp)
                        put("sdpMid", it.sdpMid)
                        put("sdpMLineIndex", it.sdpMLineIndex)
                    })
                    put("transaction", signaling.generateTransactionId())
                }
                signaling.send(json)
                logCallback("â„ï¸ ICE Candidate ì „ì†¡: ${it.sdp}")
            }
        }

        override fun onConnectionChange(newState: PeerConnection.PeerConnectionState) {
            logCallback("ğŸ“¡ ì—°ê²° ìƒíƒœ: $newState")
        }

        override fun onIceConnectionChange(state: PeerConnection.IceConnectionState) {
            logCallback("ğŸ§Š ICE ìƒíƒœ: $state")
        }

        override fun onAddTrack(receiver: RtpReceiver?, streams: Array<out MediaStream>?) {
            logCallback("ğŸ§ ì˜¤ë””ì˜¤ ìˆ˜ì‹ ë¨")
        }

        // ìƒëµ: ë‹¤ë¥¸ ì½œë°±ë“¤ í•„ìš”ì‹œ êµ¬í˜„
    })

    val constraints = MediaConstraints().apply {
        mandatory.add(MediaConstraints.KeyValuePair("OfferToReceiveAudio", "true"))
        mandatory.add(MediaConstraints.KeyValuePair("OfferToReceiveVideo", "false"))
    }

    peerConnection?.createOffer(object : SdpObserverAdapter() {
        override fun onCreateSuccess(offer: SessionDescription?) {
            offer?.let {
                peerConnection?.setLocalDescription(SdpObserverAdapter(), it)

                // ì‹œê·¸ë„ë§ ì„œë²„ì— ì „ì†¡
                val jsep = JSONObject().apply {
                    put("type", "offer")
                    put("sdp", it.description)
                }

                val message = JSONObject().apply {
                    put("janus", "message")
                    put("body", JSONObject().put("audio", true))
                    put("jsep", jsep)
                    put("transaction", signaling.generateTransactionId())
                }

                signaling.send(message)
                logCallback("ğŸ“¤ Offer ì „ì†¡ ì™„ë£Œ")
            }
        }

        override fun onCreateFailure(error: String?) {
            logCallback("âŒ Offer ìƒì„± ì‹¤íŒ¨: $error")
        }
    }, constraints)
}
```

> ğŸ“š ì°¸ê³ : WebRTCì™€ Janus ì‹œê·¸ë„ë§ ì—°ê²° íë¦„ì€ [Janus API Docs](https://janus.conf.meetecho.com/docs/) ì°¸ì¡°

---

### âœ… Step 7. ë¡œê·¸ í™•ì¸ í¬ì¸íŠ¸

| ì´ë²¤íŠ¸ | ë¡œê·¸ ë©”ì‹œì§€ ì˜ˆì‹œ |
|--------|------------------|
| ICE ì—°ê²° | `ğŸ§Š ICE ìƒíƒœ: CONNECTED` or `FAILED` |
| DTLS í•¸ë“œì‰ì´í¬ | `RemoteDescription ì„¤ì • ì™„ë£Œ` ì´í›„ mediaê°€ íë¥´ê¸° ì‹œì‘ |
| ì˜¤ë””ì˜¤ ìˆ˜ì‹  | `ğŸ§ ì˜¤ë””ì˜¤ ìˆ˜ì‹ ë¨` |
| Candidate ì „ì†¡ | `â„ï¸ ICE Candidate ì „ì†¡: candidate:...` |
| ì—°ê²° ì‹¤íŒ¨ | `ğŸ“¡ ì—°ê²° ìƒíƒœ: FAILED` or ë¡œê·¸ ì—†ìŒ |

---

## 4. Git ì •ë¦¬

```bash
git add .
git commit -m "Implement 1:1 audio connection and ICE/DTLS logging with Janus"
git push
```

---

## 5. ìˆ™ì œ(í€´ì¦ˆ)

1. **WebRTC ì—°ê²° ìƒíƒœ**
   - ICE ì—°ê²° ìƒíƒœì™€ PeerConnection ì—°ê²° ìƒíƒœì˜ ì°¨ì´ëŠ”?

2. **DTLS Handshake**
   - ì™œ DTLS Handshakeê°€ í•„ìš”í•˜ê³ , ì‹¤íŒ¨í•˜ë©´ ì–´ë–¤ ì¼ì´ ìƒê¸¸ê¹Œìš”?

3. **ì˜¤ë””ì˜¤ ê¶Œí•œ**
   - Compose ì•±ì—ì„œ ê¶Œí•œì´ ì—†ëŠ” ìƒíƒœì—ì„œ ì—°ê²°ì„ ì‹œë„í•˜ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ë‚˜ìš”?

(ë‹µì•ˆì€ `docs/Day3-quiz.md`ì— ì‘ì„± í›„ ì»¤ë°‹)

---

## 6. ì½”ë©˜íŠ¸/íŒ

- `ICE_FAILED` ìƒíƒœê°€ ìì£¼ ë°œìƒí•˜ë©´ STUN ì„¤ì •ì´ ì—†ê±°ë‚˜ ë°©í™”ë²½ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- Janusì—ì„œ EchoTest Plugin ëŒ€ì‹  `audiobridge`ë¥¼ ì‚¬ìš©í•˜ë©´ ê°€ìƒ íšŒì˜ ë°©ì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
- `setRemoteDescription()` ì´í›„ ì‹¤ì œ ì˜¤ë””ì˜¤ê°€ ë“¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤ë©´ ì˜¤ë””ì˜¤ ë¼ìš°íŒ…, ìŒì†Œê±°, device ì„¤ì • ë“±ë„ ì²´í¬

---

# âœ… ë§ˆë¬´ë¦¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] Android â†’ Janus â†’ EchoTestë¡œ 1:1 ì˜¤ë””ì˜¤ ì—°ê²° í…ŒìŠ¤íŠ¸  
- [x] ICE ì—°ê²° ìƒíƒœ ë¡œê·¸ ì¶œë ¥  
- [x] DTLS í•¸ë“œì‰ì´í¬ ë° Answer ìˆ˜ì‹  ë¡œê·¸ í™•ì¸  
- [x] ì˜¤ë””ì˜¤ ê¶Œí•œ ì²´í¬ ë° ë¯¸ë™ì‘ ì‹œ ì²˜ë¦¬  
- [x] Git ì»¤ë°‹ & Push ì™„ë£Œ  

---

ğŸ“Œ **ë‹¤ìŒ ì‹œê°„(Week 2 Day 4)**ì—ëŠ” ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê³ ,  
TURN ì„œë²„ë¥¼ ì ìš©í•´ ì•ˆì •ì ì¸ ì—°ê²°ì„ ë§Œë“¤ë©°, ì•±ì—ì„œ ìƒíƒœ í‘œì‹œ ë° UI í”¼ë“œë°± ê¸°ëŠ¥ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

ìˆ˜ê³  ë§ìœ¼ì…¨ìŠµë‹ˆë‹¤!